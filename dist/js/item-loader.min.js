import{f as e,e as r}from"./utils-BJEOp7Xj.js";import"./services.min.js";let prepareIngredientTreeData,CraftIngredient,setIngredientObjs,findIngredientsById,cancelItemRequests,recalcAll,n,t,i,o;async function a(){return o||(o=Promise.all([import("./items-core.min.js"),import("./utils-BJEOp7Xj.js").then(function(e){return e.h}),import("./services.min.js").then(function(e){return e.r}).catch(()=>import("./services/recipeService.min.js")),import("./utils-BJEOp7Xj.js").then(function(e){return e.i})]).then(([e,r,o,a])=>{if(({prepareIngredientTreeData:prepareIngredientTreeData,CraftIngredient:CraftIngredient,setIngredientObjs:setIngredientObjs,findIngredientsById:findIngredientsById,cancelItemRequests:cancelItemRequests,recalcAll:recalcAll}=e),!(prepareIngredientTreeData&&CraftIngredient&&setIngredientObjs&&findIngredientsById&&cancelItemRequests&&recalcAll))throw new Error("items-core exports missing");({preloadPrices:i}=r),({getItemBundles:n}=o),({update:t}=a)})),o}let s=0,c=null,l=null;async function d(e){if(!Array.isArray(e)||0===e.length)return[];await a();try{return await n(e)}catch(e){return console.error("Error cargando ítems",e),[]}}async function w(n){await a();const i=++s;if(l&&(l.abort(),l=null),"function"==typeof cancelItemRequests&&cancelItemRequests(),!n)return window.hideSkeleton?.(document.getElementById("item-skeleton")),void window.showError?.("ID de ítem no válido");let o=null,d=null;const w=document.getElementById("item-skeleton");try{window.showSkeleton?.(w),l=new AbortController;const a=await e(`/backend/api/itemDetails.php?itemId=${n}`,{signal:l.signal});if(404===a.status)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(w);if(!a.ok)throw new Error(`Error ${a.status} obteniendo detalles del ítem`);const u=a.headers.get("content-type")||"";if(!u.includes("application/json"))throw new Error(`Respuesta no válida: ${u}`);const{item:m,recipe:p,market:f,nested_recipe:h}=await a.json();if(!m)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(w);if(i!==s)return;if(d=f||{},window._mainBuyPrice=d.buy_price||0,window._mainSellPrice=d.sell_price||0,!p)return setIngredientObjs([]),void window.initItemUI(m,d);h&&(p.nested_recipe=h),window._mainRecipeOutputCount=p.output_item_count||1,setTimeout(async()=>{if(i!==s)return;let e;try{e=await prepareIngredientTreeData(n,p)}catch(e){return console.error("Error preparando ingredientes",e),window.showError?.("Error al preparar los ingredientes"),setIngredientObjs([]),void window.initItemUI(m,d)}Array.isArray(e)||(e=[]),o=new CraftIngredient({id:m.id,name:m.name,icon:m.icon,rarity:m.rarity,count:1,buy_price:d?.buy_price||0,sell_price:d?.sell_price||0,is_craftable:!0,recipe:p,children:e}),o.recalc(window.globalQty||1,null),setIngredientObjs([o]),await window.initItemUI(m,d),await(window.safeRenderTable?.());const a=new Set;!function e(r,n){n.add(r.id),r.children&&r.children.forEach(r=>e(r,n))}(o,a),c&&c();const l=Array.from(a),w=async e=>{if(!document.getElementById("seccion-crafting"))return void requestAnimationFrame(()=>w(e));const r=[];e.forEach((e,n)=>{const t=findIngredientsById(window.ingredientObjs,Number(n));t.length&&t.forEach(n=>{n.buy_price=e.buy_price||0,n.sell_price=e.sell_price||0,n===window.ingredientObjs[0]&&(window._mainBuyPrice=n.buy_price,window._mainSellPrice=n.sell_price),r.push(n)})}),await(window.safeRenderTable?.());const n=window.getTotals?.();n&&(t("totales-crafting-global",n),t("totales-crafting-unit",n)),r.forEach(e=>t(e._uid,e))};c=r(l,w)},0)}catch(e){if("AbortError"===e.name)return;console.error("Error cargando ítem",e),window.showError?.("Error al cargar los datos del ítem"),window.hideSkeleton?.(w)}finally{l=null}}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new URLSearchParams(window.location.search),r=parseInt(e.get("id"),10);r?w(r):window.showError?.("ID de ítem no válido")};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0)});export{w as loadItem,d as loadItems};
