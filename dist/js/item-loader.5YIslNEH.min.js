import{f as e,e as r}from"./utils-bc8VNvJR.js";import"./services-Cd2sNgr4.js";let n,t,i,o,l,a,s,c,d;async function w(){return d||(d=Promise.all([import("./items-core.DDg-XKPB.min.js"),import("./utils-bc8VNvJR.js").then(function(e){return e.h}),import("./services-Cd2sNgr4.js").then(function(e){return e.r}).catch(()=>import("./services/recipeService.min.js")),import("./utils-bc8VNvJR.js").then(function(e){return e.i})]).then(([e,r,d,w])=>{({prepareIngredientTreeData:n,CraftIngredient:t,setIngredientObjs:i,findIngredientById:o,cancelItemRequests:l}=e),({preloadPrices:c}=r),({getItemBundles:a}=d),({update:s}=w)})),d}let u=0,m=null,p=null;async function h(e){if(!Array.isArray(e)||0===e.length)return[];await w();try{return await a(e)}catch(e){return console.error("Error cargando ítems",e),[]}}async function y(a){await w();const c=++u;if(p&&(p.abort(),p=null),l(),!a)return window.hideSkeleton?.(document.getElementById("item-skeleton")),void window.showError?.("ID de ítem no válido");let d=null,h=null;const y=document.getElementById("item-skeleton");try{window.showSkeleton?.(y),p=new AbortController;const l=await e(`/backend/api/itemDetails.php?itemId=${a}`,{signal:p.signal});if(404===l.status)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(y);if(!l.ok)throw new Error(`Error ${l.status} obteniendo detalles del ítem`);const w=l.headers.get("content-type")||"";if(!w.includes("application/json"))throw new Error(`Respuesta no válida: ${w}`);const{item:f,recipe:E,market:_,nested_recipe:g}=await l.json();if(!f)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(y);if(c!==u)return;if(h=_||{},window._mainBuyPrice=h.buy_price||0,window._mainSellPrice=h.sell_price||0,!E)return i([]),void window.initItemUI(f,h);g&&(E.nested_recipe=g),window._mainRecipeOutputCount=E.output_item_count||1,setTimeout(async()=>{if(c!==u)return;let e;try{e=await n(a,E)}catch(e){return console.error("Error preparando ingredientes",e),window.showError?.("Error al preparar los ingredientes"),i([]),void window.initItemUI(f,h)}Array.isArray(e)||(e=[]),d=new t({id:f.id,name:f.name,icon:f.icon,rarity:f.rarity,count:1,buy_price:h?.buy_price||0,sell_price:h?.sell_price||0,is_craftable:!0,recipe:E,children:e}),d.recalc(window.globalQty||1,null),i([d]),window.initItemUI(f,h);const l=new Set;!function e(r,n){n.add(r.id),r.children&&r.children.forEach(r=>e(r,n))}(d,l),m&&m();const w=Array.from(l);m=r(w,e=>{e.forEach((e,r)=>{const n=o(window.ingredientObjs,Number(r));n&&(n.buy_price=e.buy_price||0,n.sell_price=e.sell_price||0,n===window.ingredientObjs[0]&&(window._mainBuyPrice=n.buy_price,window._mainSellPrice=n.sell_price),n.recalc(window.globalQty||1,null),s(r,n))})})},0)}catch(e){if("AbortError"===e.name)return;console.error("Error cargando ítem",e),window.showError?.("Error al cargar los datos del ítem"),window.hideSkeleton?.(y)}finally{p=null}}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new URLSearchParams(window.location.search),r=parseInt(e.get("id"),10);r?y(r):window.showError?.("ID de ítem no válido")};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0)});export{y as loadItem,h as loadItems};
