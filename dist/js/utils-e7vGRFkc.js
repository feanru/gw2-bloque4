const e={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},t="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let n=null;function o(e){t&&t.postMessage({type:"delete",key:e})}const r=[];function s(){const e=Date.now()-6e4;for(;r.length&&r[0]<e;)r.shift()}function i(){s();const e=r.length;return e>5?"down":e>0?"slow":"ok"}let a;function l(){if("undefined"==typeof document)return;const e=i();a||(a=document.createElement("div"),a.id="api-status-indicator",a.style.position="fixed",a.style.bottom="10px",a.style.right="10px",a.style.padding="4px 8px",a.style.background="rgba(0,0,0,0.7)",a.style.color="#fff",a.style.borderRadius="4px",a.style.zIndex="10000",a.style.display="none",document.body.appendChild(a)),"ok"===e?a.style.display="none":(a.textContent="slow"===e?"API lenta":"API ca√≠da",a.style.display="block")}var c={recordFailure:function(){r.push(Date.now()),s(),l()},recordSuccess:function(){s(),l()},getState:i,getBackoff:function(){const e=i();return"down"===e?5e3:"slow"===e?1e3:0}};async function u(e,t={}){const{timeout:n=8e3,retries:o=3,backoff:r=300,signal:s,...i}=t;for(let t=0;t<=o;t++){const a=new AbortController,l=setTimeout(()=>a.abort(),n);s&&(s.aborted?a.abort():s.addEventListener("abort",()=>a.abort(),{once:!0}));try{const t=await fetch(e,{...i,signal:a.signal});return clearTimeout(l),c.recordSuccess(),t}catch(e){if(clearTimeout(l),c.recordFailure(),s?.aborted||t===o)throw e;const n=r*Math.pow(2,t);await new Promise(e=>setTimeout(e,n))}}}const f=new Map;!function(e){n=e,t&&t.addEventListener("message",({data:e})=>{const{type:o,key:r,entry:s}=e||{};if("request-bundles"!==o)o&&r&&("set"===o&&s?n.set(r,s):"delete"===o&&n.delete(r));else{if(!n)return;n.forEach((e,n)=>{n.startsWith("bundle_")&&t.postMessage({type:"set",key:n,entry:e})})}})}(f),t&&t.postMessage({type:"request-bundles"});const d="undefined"!=typeof localStorage,p=new Map;function g(e){try{return JSON.parse(e)}catch{return null}}function y(e,t){if(d)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:n,lastModified:o}){return JSON.stringify({value:e,expiresAt:t,etag:n,lastModified:o})}(t))}catch{}}function h(n,o,r=void 0,s={}){if(void 0===r){const t=n.split("_")[0];r=e[t]}const i=null==r?null:Date.now()+r,{etag:a=null,lastModified:l=null}=s,c={value:o,expiresAt:i,updatedAt:(new Date).toISOString(),etag:a,lastModified:l};f.set(n,c),y(n,{value:o,expiresAt:i,etag:a,lastModified:l}),function(e,n){t&&t.postMessage({type:"set",key:e,entry:n})}(n,c)}function w(e,t=!1){let n=f.get(e);if(!n){const t=function(e){if(!d)return null;const t=localStorage.getItem(e);if(!t)return null;const n=g(t);return n||(localStorage.removeItem(e),null)}(e);if(t){const{value:o,expiresAt:r=null,etag:s=null,lastModified:i=null}=t;n={value:o,expiresAt:r,updatedAt:(new Date).toISOString(),etag:s,lastModified:i},f.set(e,n)}}return n?n.expiresAt&&Date.now()>n.expiresAt?(f.delete(e),d&&localStorage.removeItem(e),o(e),null):t?n:n.value:null}function m(e,t={}){const n=function(e,{method:t="GET",headers:n={}}={}){return`${e}|${t.toUpperCase()}|${JSON.stringify(n)}`}(e,t),o=p.get(n)||u(e,t).finally(()=>p.delete(n));return p.set(n,o),o.then(e=>e.clone())}!function(){if(!d)return;const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t),o=g(localStorage.getItem(n));if(!o)continue;const{expiresAt:r}=o;r&&Date.now()>r&&e.push(n)}e.forEach(e=>{localStorage.removeItem(e),o(e)})}();const S="undefined"!=typeof process&&process.env?process.env:{};S.API_BASE_URL,S.LANG,S.MARKET_CSV_URL,S.GW2_API_KEY;var b=S.PRICE_CACHE_STRATEGY||"sessionStorage";const A=new Map;function v(){return"sessionStorage"===b}function _(e){return`price_${e}`}function M(e){if(!v()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(_(e));if(!t)return null;try{const{value:n,expires:o}=JSON.parse(t);return o&&Date.now()>o?(sessionStorage.removeItem(_(e)),null):n}catch{return sessionStorage.removeItem(_(e)),null}}async function E(e=[]){const t=new Map,n=[];if(e.forEach(e=>{if(e=Number(e),A.has(e))return void t.set(e,A.get(e));const o=M(e);o?(A.set(e,o),t.set(e,o)):n.push(e)}),n.length)try{const e=await async function(e){if(!Array.isArray(e)||0===e.length)return new Map;if("redis"===b){const t=`/backend/api/itemBundle.php?ids=${e.join(",")}`,n=await fetch(t);if(!n.ok)throw new Error("Price fetch failed");const o=await n.json(),r=new Map;return o.forEach(e=>{const t=e.market||{};r.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),r}{const t=`https://api.datawars2.ie/gw2/v1/items/csv?fields=${["id","buy_price","sell_price"].join(",")}&ids=${e.join(",")}`,n=await fetch(t);if(!n.ok)throw new Error("Price fetch failed");const o=(await n.text()).trim().split("\n"),r=o[0].split(","),s=new Map;for(let e=1;e<o.length;e++){if(!o[e])continue;const t=o[e].split(","),n={};r.forEach((e,o)=>{const r=t[o];n[e]=void 0!==r?isNaN(r)?r:Number(r):null}),null!=n.id&&s.set(n.id,{buy_price:n.buy_price||0,sell_price:n.sell_price||0})}return s}}(n);e.forEach((e,n)=>{A.set(n,e),function(e,t){if(v()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(_(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(n,e),t.set(n,e)})}catch(e){console.error("Error preloading prices",e)}return e.forEach(e=>{e=Number(e),!t.has(e)&&A.has(e)&&t.set(e,A.get(e)),t.has(e)||t.set(e,{buy_price:0,sell_price:0})}),t}async function x(e){if(e=Number(e),A.has(e))return A.get(e);const t=M(e);if(t)return A.set(e,t),t;return(await E([e])).get(e)}function I(){if(A.clear(),v()&&"undefined"!=typeof sessionStorage)for(let e=sessionStorage.length-1;e>=0;e--){const t=sessionStorage.key(e);t&&t.startsWith("price_")&&sessionStorage.removeItem(t)}}function k(e,t){if(!Array.isArray(e)||!t)return;const n=new Map;!function e(t){t&&void 0!==t._uid&&n.set(String(t._uid),t);(Array.isArray(t?.components)?t.components:Array.isArray(t?.children)?t.children:[]).forEach(e)}(Array.isArray(t)?{children:t}:t);const o=["total_buy","total_sell","total_crafted","crafted_price","countTotal"];e.forEach(e=>{const t=n.get(String(e.uid));t&&o.forEach(n=>{Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})})}const N=new Map;function C(e,t={},n=null,o=null,r){const s=N.get(e);s&&s.controller?.abort(),n&&!o&&(o=w(n,!0));const i={...t.headers||{}};o?.etag&&(i["If-None-Match"]=o.etag),o?.lastModified&&(i["If-Modified-Since"]=o.lastModified);const a=r?null:new AbortController,l=r??t.signal??a?.signal;return function(e,t,n){return N.set(e,{promise:t,controller:n}),t.finally(()=>N.delete(e)),t}(e,u(e,{...t,headers:i,signal:l}).then(async e=>304===e.status&&o?new Response(JSON.stringify(o.value),{status:200,headers:{"X-Cache":"HIT",ETag:o.etag||"","Last-Modified":o.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),a).then(e=>e.clone())}export{w as a,m as b,I as c,C as f,x as g,k as m,E as p,h as s};
