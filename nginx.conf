http {
    include       mime.types;
    types { application/javascript js mjs; }

    server {
        listen 80;
        server_name example.com;
        root /var/www/html;

        # Política de íconos: los íconos se descargan desde la CDN de ArenaNet
        # o pueden servirse desde este servidor ajustando las URLs.

        # Serve web workers without SPA fallback
        location ^~ /dist/js/workers/ {
            try_files $uri =404;
            default_type application/javascript;
        }

        # Return 404 for missing files under /dist/js
        location ^~ /dist/js/ {
            try_files $uri =404;
            default_type application/javascript;
            error_page 404 = @js404;
        }

        location @js404 {
            add_header Content-Type application/javascript;
            return 404 "";
        }

        # Serve service worker directly without SPA fallback
        location = /service-worker.min.js {
            try_files $uri =404;
            default_type application/javascript;
        }

        # Cache static assets for 30 days
        location ~* \.(js|css|png|mp4)$ {
            expires 30d;
            add_header Cache-Control "public, max-age=2592000, stale-while-revalidate=2592000";
        }

        # Proxy recipe tree API to Node backend
        location /recipe-tree/ {
            proxy_pass http://127.0.0.1:3000/recipe-tree/;
        }

        # SPA fallback for other routes
        location / {
            add_header Cache-Control "no-cache";
            try_files $uri $uri/ /index.html;
        }
    }
}
