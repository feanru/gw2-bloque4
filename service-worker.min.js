const APP_VERSION="va0b72d2",STATIC_CACHE="static-va0b72d2",API_CACHE="api-va0b72d2",DEFAULT_TTL=3e5,VIDEO_ASSETS=["img/Secuencia01.mp4","img/Secuencia02.mp4","img/Secuencia03.mp4"];async function cacheFirst(e,t){const a=await caches.open(t),s=await a.match(e);if(s)return s;const n=await fetch(e);if(n.ok){const t=n.headers.get("Content-Type")||"";("script"===e.destination||new URL(e.url).pathname.endsWith(".js"))&&!t.includes("javascript")||a.put(e,n.clone())}return n}function getTTLFromResponse(e){const t=(e.headers.get("Cache-Control")||"").match(/max-age=(\d+)/);if(t)return 1e3*parseInt(t[1],10);const a=e.headers.get("X-Cache-Ttl");return a?1e3*parseInt(a,10):3e5}async function staleWhileRevalidate(e,t){const a=await caches.open(t),s=await a.match(e),n=Date.now(),i=async()=>{const t=await fetch(e);if(t.ok){const s=getTTLFromResponse(t),n=new Headers(t.headers);s&&n.set("X-Cache-Expires",Date.now()+s);const i=await t.clone().blob(),c=new Response(i,{status:t.status,statusText:t.statusText,headers:n});return await a.put(e,c.clone()),c}return t};if(s){const e=parseInt(s.headers.get("X-Cache-Expires")||"0",10);return e&&n<e?{response:s,fetchPromise:null}:{response:s,fetchPromise:i()}}return{response:i(),fetchPromise:null}}async function cleanExpired(){const e=await caches.open(API_CACHE),t=await e.keys(),a=Date.now();await Promise.all(t.map(async t=>{const s=await e.match(t),n=parseInt(s.headers.get("X-Cache-Expires")||"0",10);if(n&&a>n)await e.delete(t);else if(!n){const n=s.headers.get("Date"),i=n?new Date(n).getTime():0;i&&a-i>3e5&&await e.delete(t)}}))}async function invalidateItem(e){const t=await caches.open(API_CACHE),a=await t.keys();await Promise.all(a.map(a=>{const s=new URL(a.url);return s.searchParams.get("itemId")===String(e)||s.pathname.endsWith(`/items/${e}`)||s.searchParams.get("output")===String(e)?t.delete(a):null}))}self.addEventListener("install",e=>{self.skipWaiting(),e.waitUntil(caches.open(STATIC_CACHE).then(e=>e.addAll(VIDEO_ASSETS)))}),self.addEventListener("activate",e=>{e.waitUntil((async()=>{await Promise.all([caches.keys().then(e=>Promise.all(e.filter(e=>(e.startsWith("static-")||e.startsWith("api-"))&&![STATIC_CACHE,API_CACHE].includes(e)).map(e=>caches.delete(e)))),cleanExpired()]),await self.clients.claim(),clients.matchAll({type:"window"}).then(e=>{e.forEach(e=>e.postMessage({type:"reload"})),e.forEach(e=>e.navigate(e.url))})})())}),self.addEventListener("fetch",e=>{const{request:t}=e;if("GET"!==t.method)return;const a=new URL(t.url);VIDEO_ASSETS.some(e=>a.pathname==="/"+e)||a.pathname.startsWith("/dist/js/")||a.pathname.startsWith("/css/")?e.respondWith(cacheFirst(t,STATIC_CACHE)):["/backend/api/user.php","/backend/api/favorites.php","/backend/api/comparisons.php"].includes(a.pathname)?e.respondWith(fetch(t,{cache:"no-store"})):a.pathname.startsWith("/backend/api/")&&!["/backend/api/user.php","/backend/api/favorites.php","/backend/api/comparisons.php"].includes(a.pathname)&&e.respondWith((async()=>{const{response:a,fetchPromise:s}=await staleWhileRevalidate(t,API_CACHE);return e.waitUntil((async()=>{s&&await s,await cleanExpired()})()),a})())}),self.addEventListener("message",e=>{const{data:t}=e;t&&("clean"===t.type?e.waitUntil(cleanExpired()):"invalidate"===t.type&&t.url?e.waitUntil(caches.open(API_CACHE).then(e=>e.delete(t.url))):"invalidateItem"===t.type&&null!=t.id?e.waitUntil(invalidateItem(t.id)):"invalidateAll"===t.type&&e.waitUntil(caches.delete(API_CACHE)))});